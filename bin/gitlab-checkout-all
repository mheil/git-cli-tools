#!/bin/python3
import getopt
import os
import re
import subprocess
import sys

import requests

gitlabUrl = os.environ['GITLAB_URL']
gitlabToken = os.environ['GITLAB_TOKEN']

simulate = False
verbose = False
destdir = os.path.join(".")
exclusionFile = ".gitlabignore"
excludes = []

opts, args = getopt.getopt(sys.argv[1:], "hd:se:v", ["help", "simulate", "dest=", "exclude=", "--exclude-file=", '--verbose'])
for opt, arg in opts:
    if opt in ('-h', '--help'):
        print('''gitlab-checkout [-h] [-s|--simulate] [-d <path>|--dest=<path>] [-e <regex>|--exclude=<regex>]
        
  options:
    -h                        print help
    -s --simulate             simulate only, don't perform any checkout
    -d --dest         <path>  directory to checkout into (defaults to working dir)
    -e --exclude      <regex> exclude projects matching provided regex
       --exclude-file <file>  read exclusion patterns from file (default: .gitlabignore)
                              the exclusion file is searched in current workdir and user home directory
    -v --verbose              print messages about whats going on
  
  example:

    gitlab-checkout -e group1 --exclude=group2 -d dest
  
  perform checkout of all projects accessible using the token that do not match the regex group1 or group2  into directory dest
''')
        sys.exit(-1)
    elif opt in ('-d', '--dest'):
        destdir = os.path.join(arg)
    elif opt in ('-s', '--simulate'):
        simulate = True
    elif opt in ('-e', '--exclude'):
        excludes.append(arg)
    elif opt == '--exclude-file':
        exclusionFile = os.path.join(arg)
    elif opt in ('-v', '--verbose'):
        verbose = True

if not os.path.exists(exclusionFile):
    userignoreFile = os.path.join(os.path.expanduser("~"), exclusionFile)
    if verbose:
        print(exclusionFile + " does not exist, fallback to " + userignoreFile)
    exclusionFile = userignoreFile

if os.path.exists(exclusionFile):
    if verbose:
        print("reading exclusion patterns from " + exclusionFile)
    for line in open(exclusionFile, 'r').readlines():
        line = line.strip()
        if verbose:
            print("exclude projects matching " + line)
        excludes.append(line)

session = requests.Session()
response = session.get(gitlabUrl + "/api/v4/projects",
                       params={'simple': 'true', 'per_page': 1000},
                       headers={'PRIVATE-TOKEN': gitlabToken})
projectList = response.json()

def isExcluded(exclusions, path):
    for exclusion in exclusions:
        if re.search(exclusion, path):
            return True
    return False

for project in projectList:
    path = os.path.join(destdir, project['path_with_namespace'])
    url = project['ssh_url_to_repo']

    if isExcluded(excludes, url):
        if verbose:
            print(path + " is excluded")
        continue

    if os.path.exists(path):
        if verbose:
            print(path + " already checked out")
        continue

    print("checkout " + url + " to " + path)
    if simulate:
        continue

    parentDir = os.path.dirname(path)
    if not os.path.exists(parentDir):
        os.makedirs(parentDir)

    subprocess.run("git clone " + url + " " + path, shell=True)
